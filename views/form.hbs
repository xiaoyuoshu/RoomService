<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>公用房预约</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../layui/css/layui.css"  media="all">
    <link rel="stylesheet" href="../stylesheets/index.css"  media="all">
    <script>
        document.title = '公用房预约 | 开始预约'
    </script>
    <script src="../layui/layui.js"></script>
    <script src="/javascripts/jquery-3.1.1.min.js"></script>
</head>

<body class="layui-layout-body" style="background: #EBEDF4">
<!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
<!--[if lt IE 9]>
<script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
<script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<div class="layui-layout layui-layout-admin">
    <!-- 头部导航栏 -->
    <div class="layui-header">
        <div class="layui-logo" style="font-size: 40px;padding-left: 50px;width: auto;color: gainsboro">电信学院-公用房预约</div>
        <!-- 头部区域（可配合layui已有的水平导航） -->
        <ul class="layui-nav layui-layout-left" style="padding-left: 250px">
            <li class="layui-nav-item"><a href="/">使用情况</a></li>
            <li class="layui-nav-item"><a href="/form">开始预约</a></li>
            <li class="layui-nav-item"><a href="/tips">使用说明</a></li>
        </ul>
    </div>


    <!-- 主体内容 -->
    <div class="layui-body" style="left: 0">
        <div class="layui-row">
            <div class="layui-col-md6 layui-col-md-offset3">
                <form class="layui-form layui-form-pane" lay-filter="f" action="" style="margin-top: 50px;padding-left: 5px;padding-right: 5px">
                    <div class="layui-form-item">
                        <label class="layui-form-label">申请人</label>
                        <div class="layui-input-block">
                            <input type="text" name="applicant" required  lay-verify="required" placeholder="如：张三" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">常用邮箱</label>
                        <div class="layui-input-block">
                            <input id = "email" type="email" name="email" required  lay-verify="email" placeholder="通过该邮箱告知您的申请状态" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">提交方式</label>
                        <div class="layui-input-block">
                            <select name="submit_type" lay-verify="required"  lay-filter="submit_type">
                                <option value=""></option>
                                <option value="0">正常预约</option>
                                <option value="1">修改已预约信息</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">申请单位</label>
                        <div class="layui-input-block">
                            <select name="department_type" lay-verify="required"  lay-filter="department_type">
                                <option value=""></option>
                                <option value="0">分团委学生会</option>
                                <option value="1">党支部</option>
                                <option value="2">班级</option>
                                <option value="3">各个院队</option>
                                <option value="4">个人</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item" id="department">
                        <label class="layui-form-label">单位详细</label>
                        <div class="layui-input-block">
                            <input type="text" name="department" required  lay-verify="required" placeholder="如：xx班/xx部门/xx党支部/xx队" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">申请理由</label>
                        <div class="layui-input-block">
                            <input type="text" name="reason" required  lay-verify="required" placeholder="如：部门例会" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">申请日期</label>
                        <div class="layui-input-block">
                            <input type="date" name="date" required  lay-verify="date" placeholder="如：2018-10-18" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">开始时间</label>
                        <div class="layui-input-block">
                            <input type="time" name="begin" required  lay-verify="required" placeholder="如：20:00" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">结束时间</label>
                        <div class="layui-input-block">
                            <input type="time" name="end" required  lay-verify="required" placeholder="如：21:00" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <script>
                            $('#existedApp').click(function () {
                                alert('Hello!');
                            });
                        </script>
                        <div class="layui-input-block">
                            <button class="layui-btn" lay-submit lay-filter="formDemo">提交</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 底部信息栏 -->
    <div class="layui-footer" style="left:0;text-align: center">
        © 电信学院 - 科协技术部&办公室 | E-mail：xiaoyuo@hust.edu.cn
    </div>
</div>

<!-- js脚本部分 -->

<script>
    //JavaScript代码区域
    /**
     * element:导航栏
     * form:表单
     * layer:弹出框
     */
    layui.use(['element','form','layer'], function(){
        var element = layui.element;
        var form = layui.form;
        var layer = layui.layer;
        var saveDate = null;
        form.on('select(department_type)', function(data){
            var department_label = $('#department>label');
            if(data.value == 1){
                department_label.text('支部名称')
            } else if(data.value == 2) {
                department_label.text('班级名称')
            } else if(data.value == 3) {
                department_label.text('队名')
            } else if(data.value == 4) {
                department_label.text('所在班级')
            } else if(data.value == 0) {
                department_label.text('部门名称')
            }
        });
        form.on('select(submit_type)', function(data){
            if(data.value == 1){
                var email_input = $('#email');
                var em = email_input.val();
                $.ajax({
                    url: '/getExited',
                    data: {
                        email: em
                    },
                    type: 'post',
                    dataType: 'json',
                    success: function (data) {
                        if(data == -1) {
                            layer.open({
                                type: 1
                                ,offset: 'auto'
                                ,id: 'layerDemo'+'auto'
                                ,content: '<div style="padding: 20px 100px;">'+ '<P>未找到申请记录！</p><p>请检查邮箱是否正确！</p><p>更改邮箱后请再次选择提交方式</p>' +'</div>'
                                ,btn: '我知道了'
                                ,btnAlign: 'c'
                                ,shade: 0
                                ,yes: function(){
                                    layer.closeAll();
                                }
                            });
                        } else {
                            var begin_date = new Date(data.result.begin_time);
                            var end_date = new Date(data.result.end_time);
                            saveDate = data.result.init_time;
                            form.val("f", {
                                applicant: data.result.applicant,
                                begin: begin_date.getHours() +':' +(begin_date.getMinutes()<10?('0'+begin_date.getMinutes()):(begin_date.getMinutes())),
                                date: begin_date.getFullYear()+'-'+(begin_date.getMonth()+1)+'-'+(begin_date.getDate()<10?('0'+begin_date.getDate()):(begin_date.getDate())),
                                department: data.result.department,
                                department_type: "0",
                                email: em,
                                end: end_date.getHours() +':' +(end_date.getMinutes()<10?('0'+end_date.getMinutes()):(end_date.getMinutes())),
                                reason: data.result.reason,
                                submit_type: "1"
                            })
                        }
                    }
                });
            }
        });
        form.on('submit(formDemo)', function(data){
            console.log(data.field)
            var applcant = data.field.applicant;
            var department = data.field.department;
            var reason = data.field.reason;
            var DATE = data.field.date;
            var BEGIN = data.field.begin;
            var END = data.field.end;
            var Mail = data.field.email;
            var Date_format = /^((((19|20)\d{2})-(0?[13-9]|1[012])-(0?[1-9]|[12]\d|30))|(((19|20)\d{2})-(0?[13578]|1[02])-31)|(((19|20)\d{2})-0?2-(0?[1-9]|1\d|2[0-8]))|((((19|20)([13579][26]|[2468][048]|0[48]))|(2000))-0?2-29))$/;
            var time_format = /([01]\d|2[0-3]):([0-5]\d)/;
            if(Date_format.test(DATE) && time_format.test(BEGIN) && time_format.test(END)) {
                var D = DATE.split('-');
                var B = BEGIN.split(':');
                var E = END.split(':');
                var begin_time = new Date(D[0], parseInt(D[1]) - 1, D[2], B[0], B[1]);
                var end_time = new Date(D[0], parseInt(D[1]) - 1, D[2], E[0], E[1]);
                var init_time = new Date();
                if (begin_time - 12 * 60 * 60 * 1000 < init_time) {
                    layer.open({
                        type: 1
                        ,offset: 'auto'
                        ,id: 'layerDemo'+'auto'
                        ,content: '<div style="padding: 20px 100px;">'+ '只允许提前十二小时申请' +'</div>'
                        ,btn: '我知道了'
                        ,btnAlign: 'c'
                        ,shade: 0
                        ,yes: function(){
                            layer.closeAll();
                        }
                    });
                }
                else if (end_time - 30 * 60 * 1000 <= begin_time) {
                    layer.open({
                        type: 1
                        ,offset: 'auto'
                        ,id: 'layerDemo'+'auto'
                        ,content: '<div style="padding: 20px 100px;">'+ '至少申请半个小时' +'</div>'
                        ,btn: '我知道了'
                        ,btnAlign: 'c'
                        ,shade: 0
                        ,yes: function(){
                            layer.closeAll();
                        }
                    });
                }
                else if (end_time - begin_time > 10800000) {
                    layer.open({
                        type: 1
                        ,offset: 'auto'
                        ,id: 'layerDemo'+'auto'
                        ,content: '<div style="padding: 20px 100px;">'+ '至多申请三个小时' +'</div>'
                        ,btn: '我知道了'
                        ,btnAlign: 'c'
                        ,shade: 0
                        ,yes: function(){
                            layer.closeAll();
                        }
                    });
                }
                else {
                    $.ajax({
                        url: '/submit',
                        data: {
                            applicant: applcant,
                            department: department,
                            reason: reason,
                            init_time: data.field.submit_type==0?init_time.getTime():saveDate,
                            begin_time: begin_time.getTime(),
                            end_time: end_time.getTime(),
                            email: Mail,
                            submitType: data.field.submit_type
                        },
                        type: 'post',
                        dataType: 'json',
                        success: function (data) {
                            if (data == "1") {
                                layer.open({
                                    type: 1
                                    ,offset: 'auto'
                                    ,id: 'layerDemo'+'auto'
                                    ,content: '<div style="padding: 20px 100px;">'+ '申请成功' +'</div>'
                                    ,btn: '我知道了'
                                    ,btnAlign: 'c'
                                    ,shade: 0
                                    ,yes: function(){
                                        layer.closeAll();
                                    }
                                });
                            } else if(data == '0'){
                                layer.open({
                                    type: 1
                                    ,offset: 'auto'
                                    ,id: 'layerDemo'+'auto'
                                    ,content: '<div style="padding: 20px 100px;">'+ '<p style="text-align: center">申请失败！</p><p>对应邮箱存在已申请且未开始进行的申请。</p>若想要修改申请请先录入已预约信息。<p></p>' +'</div>'
                                    ,btn: '我知道了'
                                    ,btnAlign: 'c'
                                    ,shade: 0
                                    ,yes: function(){
                                        layer.closeAll();
                                    }
                                });
                            } else if(data == '-2') {
                                layer.open({
                                    type: 1
                                    ,offset: 'auto'
                                    ,id: 'layerDemo'+'auto'
                                    ,content: '<div style="padding: 20px 100px;">'+ '<p style="text-align: center">更改失败！</p><p style="text-align: center">更改时只允许更改开始时间和结束时间</p>' +'</div>'
                                    ,btn: '我知道了'
                                    ,btnAlign: 'c'
                                    ,shade: 0
                                    ,yes: function(){
                                        layer.closeAll();
                                    }
                                });
                            } else {
                                layer.open({
                                    type: 1
                                    ,offset: 'auto'
                                    ,id: 'layerDemo'+'auto'
                                    ,content: '<div style="padding: 20px 100px;">'+ '<p style="text-align: center">申请失败！</p><p style="text-align: center">与已有申请成功信息冲突</p>' +'</div>'
                                    ,btn: '我知道了'
                                    ,btnAlign: 'c'
                                    ,shade: 0
                                    ,yes: function(){
                                        layer.closeAll();
                                    }
                                });
                            }
                        }
                    })
                }
            }
            else{
                layer.open({
                    type: 1
                    ,offset: 'auto'
                    ,id: 'layerDemo'+'auto'
                    ,content: '<div style="padding: 20px 100px;">'+ '日期和时间格式不正确！\n若浏览器没有日期或时间控件，请按照如下格式填写\n日期如：2018-01-01\n时间如：20:00' +'</div>'
                    ,btn: '我知道了'
                    ,btnAlign: 'c'
                    ,shade: 0
                    ,yes: function(){
                        layer.closeAll();
                    }
                });
            }
            return false;
        });
    });
</script>

</body>